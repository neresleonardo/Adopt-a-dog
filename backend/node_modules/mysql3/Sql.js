"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.raw = raw;
exports.selectAs = selectAs;
exports.set = set;
exports.timestamp = timestamp;
exports.point = point;
exports.polygon = polygon;
exports.escapeValue = escapeValue;
exports.escapeLike = escapeLike;
exports.escapeId = escapeId;
exports.date = date;
exports.interval = interval;
exports.sql = sql;
exports.IntervalUnit = exports.SqlFrag = void 0;

var _momentTimezone = _interopRequireDefault(require("moment-timezone"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const ID_GLOBAL_REGEXP = /`/g;
const QUAL_GLOBAL_REGEXP = /\./g;

class SqlFrag {
  constructor(sql) {
    this.sql = sql;
  }

  toString() {
    throw new Error("SqlFrag cannot be cast to string");
  }

  toSqlString() {
    return this.sql;
  }

}

exports.SqlFrag = SqlFrag;

function isSafe(x) {
  return x instanceof SqlFrag;
}

function raw(...args) {
  return sql.raw(...args);
}

function selectAs(fields) {
  return new SqlFrag(Object.keys(fields).map(fieldName => `${_escapeIdLoose(fieldName)} AS ${_escapeIdStrict(fields[fieldName])}`).join(', '));
}

function set(...args) {
  return sql.set(...args);
}

function timestamp(...args) {
  return sql.timestamp(...args);
}

function point(...args) {
  return sql.point(...args);
}

function polygon(...args) {
  return sql.polygon(...args);
}

function escapeValue(value) {
  if (isSafe(value)) return value;
  return new SqlFrag(_escapeValue(value));
}

function escapeRegExp(string) {
  return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
}

function escapeLike(value, escChar = '\\') {
  if (escChar.length !== 1 || escChar === '%' || escChar === '_') throw new Error("Bad escape char");
  return value.replace(new RegExp(`[%_${escapeRegExp(escChar)}]`, 'g'), m => escChar + m);
}

function _escapeValue(value) {
  if (isSafe(value)) {
    return value.toSqlString();
  }

  if (Array.isArray(value)) {
    return value.map(v => _escapeValue(v)).join(',');
  }

  if (Buffer.isBuffer(value)) {
    return `x'${value.toString('hex')}'`;
  }

  if (typeof value === 'number' || typeof value === 'bigint') {
    return String(value);
  }

  if (typeof value === 'string') {
    return _escapeString(value);
  }

  if (value === true) {
    return '1';
  }

  if (value === false) {
    return '0';
  }

  if (value === null) {
    return 'NULL';
  }

  throw new Error(`Unsupported value type: ${value}`);
}

const CHARS_REGEX = /[\x00\b\n\r\t\x1A'\\]/gu;
const CHARS_ESCAPE_MAP = {
  '\0': '\\0',
  '\b': '\\b',
  '\n': '\\n',
  '\r': '\\r',
  '\t': '\\t',
  '\x1a': '\\Z',
  '\'': "''",
  '\\': '\\\\'
};

function _escapeString(value) {
  return "'" + String(value).replace(CHARS_REGEX, m => CHARS_ESCAPE_MAP[m]) + "'";
}

function escapeId(id) {
  if (isSafe(id)) return id;
  if (Array.isArray(id)) return new SqlFrag(id.map(_escapeIdStrict).join('.'));
  return new SqlFrag(_escapeIdStrict(id));
}

function _escapeIdLoose(id) {
  if (isSafe(id)) return id.toSqlString();
  if (Array.isArray(id)) return id.map(_escapeIdStrict).join('.');
  return '`' + String(id).replace(ID_GLOBAL_REGEXP, '``').replace(QUAL_GLOBAL_REGEXP, '`.`') + '`';
}

function _escapeIdStrict(id) {
  if (isSafe(id)) return id.toSqlString();
  if (Array.isArray(id)) return id.map(_escapeIdStrict).join('.');
  return '`' + String(id).replace(ID_GLOBAL_REGEXP, '``') + '`';
}

function date(value, outputTimezone, inputTimezone) {
  const date = makeMoment(value, outputTimezone, inputTimezone);
  return new SqlFrag(`DATE'${date.format('YYYY-MM-DD')}'`);
}

function makeMoment(value, outputTimezone, inputTimezone) {
  let d;

  if (inputTimezone) {
    const zone = _momentTimezone.default.tz.zone(inputTimezone);

    if (!zone) throw new Error(`Invalid input timezone: ${inputTimezone}`);
    d = _momentTimezone.default.tz(value, zone.name);
  } else {
    d = (0, _momentTimezone.default)(value);
  }

  if (!d.isValid()) {
    throw new Error(`Input date is not valid`);
  }

  if (outputTimezone) {
    const zone = _momentTimezone.default.tz.zone(outputTimezone);

    if (!zone) throw new Error(`Invalid output timezone: ${outputTimezone}`);
    d.tz(zone.name);
  }

  return d;
}

function hasOwn(obj, key) {
  return Object.prototype.hasOwnProperty.call(obj, key);
}

function toPairs(points) {
  if (!points.length) return [];
  const sample = points[0];

  if (Array.isArray(sample) && sample.length === 2) {
    return [...points];
  }

  if (hasOwn(sample, 'x') && hasOwn(sample, 'y')) {
    return points.map(pt => [pt.x, pt.y]);
  }

  if (hasOwn(sample, 'lat') && hasOwn(sample, 'lng')) {
    return points.map(pt => [pt.lat, pt.lng]);
  }

  throw new Error("Points are not in an expected format");
}

let IntervalUnit;
exports.IntervalUnit = IntervalUnit;

(function (IntervalUnit) {
  IntervalUnit["MICROSECOND"] = "MICROSECOND";
  IntervalUnit["MILLISECOND"] = "MILLISECOND";
  IntervalUnit["SECOND"] = "SECOND";
  IntervalUnit["MINUTE"] = "MINUTE";
  IntervalUnit["HOUR"] = "HOUR";
  IntervalUnit["DAY"] = "DAY";
  IntervalUnit["WEEK"] = "WEEK";
  IntervalUnit["MONTH"] = "MONTH";
  IntervalUnit["QUARTER"] = "QUARTER";
  IntervalUnit["YEAR"] = "YEAR";
})(IntervalUnit || (exports.IntervalUnit = IntervalUnit = {}));

function interval(value, unit = IntervalUnit.MILLISECOND) {
  if (unit === IntervalUnit.MILLISECOND) {
    value *= 1000;
    unit = IntervalUnit.MICROSECOND;
  }

  return new SqlFrag(`INTERVAL ${Math.round(value)} ${unit}`);
}

function sql(strings, ...values) {
  let out = [];
  let i = 0;

  for (; i < values.length; ++i) {
    out.push(strings.raw[i], escapeValue(values[i]).toSqlString());
  }

  out.push(strings.raw[i]);
  return new SqlFrag(out.join(''));
}

(function (_sql) {
  function set(fields) {
    if (Array.isArray(fields)) {
      return new SqlFrag(fields.map(f => `${escapeId(f[0]).toSqlString()}=${escapeValue(f[1]).toSqlString()}`).join(', '));
    }

    return new SqlFrag(Object.keys(fields).map(fieldName => `${_escapeIdLoose(fieldName)}=${escapeValue(fields[fieldName]).toSqlString()}`).join(', '));
  }

  _sql.set = set;

  function insert(table, data, options) {
    let q = sql`INSERT ${sql.raw((options == null ? void 0 : options.ignore) ? 'IGNORE ' : '')}INTO ${escapeId(table)} SET ${sql.set(data)}`;

    if (options == null ? void 0 : options.ignoreDupes) {
      if (options == null ? void 0 : options.updateOnDupe) {
        throw new Error("`ignoreDupes` and `updateOnDupe` are incompatible");
      }

      let firstCol;

      if (Array.isArray(data)) {
        firstCol = data[0][0];
      } else {
        firstCol = Object.keys(data)[0];
      }

      const escCol = new SqlFrag(_escapeIdLoose(firstCol));
      q = sql`${q} ON DUPLICATE KEY UPDATE ${escCol}=VALUES(${escCol})`;
    }

    if (options == null ? void 0 : options.updateOnDupe) {
      let cols;

      if (Array.isArray(data)) {
        cols = data.map(f => f[0]);
      } else {
        cols = Object.keys(data);
      }

      q = sql`${q} ON DUPLICATE KEY UPDATE ${cols.map(col => {
        const escCol = new SqlFrag(_escapeIdLoose(col));
        return sql`${escCol}=VALUES(${escCol})`;
      })}`;
    }

    return q;
  }

  _sql.insert = insert;

  function as(fields) {
    if (Array.isArray(fields)) {
      return new SqlFrag(fields.map(f => `${escapeId(f[0]).toSqlString()} AS ${_escapeString(f[1])}`).join(', '));
    }

    return new SqlFrag(Object.keys(fields).map(alias => `${_escapeIdStrict(fields[alias])} AS ${_escapeString(alias)}`).join(', '));
  }

  _sql.as = as;

  function raw(sqlString) {
    if (sqlString instanceof SqlFrag) return sqlString;
    return new SqlFrag(sqlString);
  }

  _sql.raw = raw;

  function timestamp(value, outputTimezone, inputTimezone, fsp) {
    const date = makeMoment(value, outputTimezone, inputTimezone);
    let frac = '';

    if (fsp != null) {
      if (fsp < 0 || fsp > 6) {
        throw new Error(`fsp out of range: ${fsp}`);
      } else if (fsp > 0) {
        frac = '.' + 'S'.repeat(fsp);
      }
    } else if (date.milliseconds() !== 0) {
      frac = '.SSS';
    }

    return new SqlFrag(`TIMESTAMP'${date.format(`YYYY-MM-DD HH:mm:ss${frac}`)}'`);
  }

  _sql.timestamp = timestamp;

  function point(x, y) {
    return sql`PointFromText(${`POINT(${x} ${y})`})`;
  }

  _sql.point = point;

  function polygon(points, autoComplete = true) {
    if (!points.length) throw new Error("Cannot create an empty polygon");
    points = toPairs(points);

    if (autoComplete) {
      const l = points.length - 1;

      if (!(points[0][0] === points[l][0] && points[0][1] === points[l][1])) {
        points.push([points[0][0], points[0][1]]);
      }
    }

    return sql`PolyFromText(${`POLYGON((${points.map(([x, y]) => `${x} ${y}`).join(',')}))`})`;
  }

  _sql.polygon = polygon;
})(sql || (exports.sql = sql = {}));
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9TcWwudHMiXSwibmFtZXMiOlsiSURfR0xPQkFMX1JFR0VYUCIsIlFVQUxfR0xPQkFMX1JFR0VYUCIsIlNxbEZyYWciLCJjb25zdHJ1Y3RvciIsInNxbCIsInRvU3RyaW5nIiwiRXJyb3IiLCJ0b1NxbFN0cmluZyIsImlzU2FmZSIsIngiLCJyYXciLCJhcmdzIiwic2VsZWN0QXMiLCJmaWVsZHMiLCJPYmplY3QiLCJrZXlzIiwibWFwIiwiZmllbGROYW1lIiwiX2VzY2FwZUlkTG9vc2UiLCJfZXNjYXBlSWRTdHJpY3QiLCJqb2luIiwic2V0IiwidGltZXN0YW1wIiwicG9pbnQiLCJwb2x5Z29uIiwiZXNjYXBlVmFsdWUiLCJ2YWx1ZSIsIl9lc2NhcGVWYWx1ZSIsImVzY2FwZVJlZ0V4cCIsInN0cmluZyIsInJlcGxhY2UiLCJlc2NhcGVMaWtlIiwiZXNjQ2hhciIsImxlbmd0aCIsIlJlZ0V4cCIsIm0iLCJBcnJheSIsImlzQXJyYXkiLCJ2IiwiQnVmZmVyIiwiaXNCdWZmZXIiLCJTdHJpbmciLCJfZXNjYXBlU3RyaW5nIiwiQ0hBUlNfUkVHRVgiLCJDSEFSU19FU0NBUEVfTUFQIiwiZXNjYXBlSWQiLCJpZCIsImRhdGUiLCJvdXRwdXRUaW1lem9uZSIsImlucHV0VGltZXpvbmUiLCJtYWtlTW9tZW50IiwiZm9ybWF0IiwiZCIsInpvbmUiLCJtb21lbnQiLCJ0eiIsIm5hbWUiLCJpc1ZhbGlkIiwiaGFzT3duIiwib2JqIiwia2V5IiwicHJvdG90eXBlIiwiaGFzT3duUHJvcGVydHkiLCJjYWxsIiwidG9QYWlycyIsInBvaW50cyIsInNhbXBsZSIsInB0IiwieSIsImxhdCIsImxuZyIsIkludGVydmFsVW5pdCIsImludGVydmFsIiwidW5pdCIsIk1JTExJU0VDT05EIiwiTUlDUk9TRUNPTkQiLCJNYXRoIiwicm91bmQiLCJzdHJpbmdzIiwidmFsdWVzIiwib3V0IiwiaSIsInB1c2giLCJmIiwiaW5zZXJ0IiwidGFibGUiLCJkYXRhIiwib3B0aW9ucyIsInEiLCJpZ25vcmUiLCJpZ25vcmVEdXBlcyIsInVwZGF0ZU9uRHVwZSIsImZpcnN0Q29sIiwiZXNjQ29sIiwiY29scyIsImNvbCIsImFzIiwiYWxpYXMiLCJzcWxTdHJpbmciLCJmc3AiLCJmcmFjIiwicmVwZWF0IiwibWlsbGlzZWNvbmRzIiwiYXV0b0NvbXBsZXRlIiwibCJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBOzs7O0FBRUEsTUFBTUEsZ0JBQWdCLEdBQUcsSUFBekI7QUFDQSxNQUFNQyxrQkFBa0IsR0FBRyxLQUEzQjs7QUFFTyxNQUFNQyxPQUFOLENBQWM7QUFDakJDLEVBQUFBLFdBQVcsQ0FBa0JDLEdBQWxCLEVBQStCO0FBQUEsU0FBYkEsR0FBYSxHQUFiQSxHQUFhO0FBQ3pDOztBQUVEQyxFQUFBQSxRQUFRLEdBQUc7QUFDUCxVQUFNLElBQUlDLEtBQUosQ0FBVSxrQ0FBVixDQUFOO0FBQ0g7O0FBRURDLEVBQUFBLFdBQVcsR0FBRztBQUNWLFdBQU8sS0FBS0gsR0FBWjtBQUNIOztBQVZnQjs7OztBQWFyQixTQUFTSSxNQUFULENBQWdCQyxDQUFoQixFQUFzQztBQUNsQyxTQUFPQSxDQUFDLFlBQVlQLE9BQXBCO0FBQ0g7O0FBS00sU0FBU1EsR0FBVCxDQUFhLEdBQUdDLElBQWhCLEVBQWtEO0FBQ3JELFNBQU9QLEdBQUcsQ0FBQ00sR0FBSixDQUFRLEdBQUdDLElBQVgsQ0FBUDtBQUNIOztBQUtNLFNBQVNDLFFBQVQsQ0FBa0JDLE1BQWxCLEVBQTJEO0FBQzlELFNBQU8sSUFBSVgsT0FBSixDQUFZWSxNQUFNLENBQUNDLElBQVAsQ0FBWUYsTUFBWixFQUFvQkcsR0FBcEIsQ0FBd0JDLFNBQVMsSUFBSyxHQUFFQyxjQUFjLENBQUNELFNBQUQsQ0FBWSxPQUFNRSxlQUFlLENBQUNOLE1BQU0sQ0FBQ0ksU0FBRCxDQUFQLENBQW9CLEVBQTNHLEVBQThHRyxJQUE5RyxDQUFtSCxJQUFuSCxDQUFaLENBQVA7QUFDSDs7QUFLTSxTQUFTQyxHQUFULENBQWEsR0FB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Q3RDLE1BQU0sQ0FBQ2hDLE1BQVosRUFBb0IsTUFBTSxJQUFJM0IsS0FBSixDQUFVLGdDQUFWLENBQU47QUFDcEIyRCxJQUFBQSxNQUFNLEdBQUdELE9BQU8sQ0FBQ0MsTUFBRCxDQUFoQjs7QUFDQSxRQUFJc0MsWUFBSixFQUFrQjtBQUNkLFlBQU1DLENBQUMsR0FBR3ZDLE1BQU0sQ0FBQ2hDLE1BQVAsR0FBZ0IsQ0FBMUI7O0FBQ0EsVUFBSSxFQUFFZ0MsTUFBTSxDQUFDLENBQUQsQ0FBTixDQUFVLENBQVYsTUFBaUJBLE1BQU0sQ0FBQ3VDLENBQUQsQ0FBTixDQUFVLENBQVYsQ0FBakIsSUFBaUN2QyxNQUFNLENBQUMsQ0FBRCxDQUFOLENBQVUsQ0FBVixNQUFpQkEsTUFBTSxDQUFDdUMsQ0FBRCxDQUFOLENBQVUsQ0FBVixDQUFwRCxDQUFKLEVBQXVFO0FBQ25FdkMsUUFBQUEsTUFBTSxDQUFDaUIsSUFBUCxDQUFZLENBQUNqQixNQUFNLENBQUMsQ0FBRCxDQUFOLENBQVUsQ0FBVixDQUFELEVBQWVBLE1BQU0sQ0FBQyxDQUFELENBQU4sQ0FBVSxDQUFWLENBQWYsQ0FBWjtBQUNIO0FBQ0o7O0FBQ0QsV0FBTzdELEdBQUksZ0JBQWdCLFlBQ3ZCNkQsTUFBTSxDQUFDakQsR0FBUCxDQUFXLENBQUMsQ0FBQ1AsQ0FBRCxFQUFJMkQsQ0FBSixDQUFELEtBQWEsR0FBRTNELENBQUUsSUFBRzJELENBQUUsRUFBakMsRUFBb0NoRCxJQUFwQyxDQUF5QyxHQUF6QyxDQUNILElBQUksR0FGTDtBQUdIOzs7R0FsRlloQixHLG1CQUFBQSxHIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IG1vbWVudCBmcm9tICdtb21lbnQtdGltZXpvbmUnO1xuXG5jb25zdCBJRF9HTE9CQUxfUkVHRVhQID0gL2AvZztcbmNvbnN0IFFVQUxfR0xPQkFMX1JFR0VYUCA9IC9cXC4vZztcblxuZXhwb3J0IGNsYXNzIFNxbEZyYWcge1xuICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgcmVhZG9ubHkgc3FsOiBzdHJpbmcpIHtcbiAgICB9XG5cbiAgICB0b1N0cmluZygpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiU3FsRnJhZyBjYW5ub3QgYmUgY2FzdCB0byBzdHJpbmdcIik7XG4gICAgfVxuXG4gICAgdG9TcWxTdHJpbmcoKSB7XG4gICAgICAgIHJldHVybiB0aGlzLnNxbDtcbiAgICB9XG59XG5cbmZ1bmN0aW9uIGlzU2FmZSh4OiBhbnkpOiB4IGlzIFNxbEZyYWcge1xuICAgIHJldHVybiB4IGluc3RhbmNlb2YgU3FsRnJhZztcbn1cblxuLyoqXG4gKiBAZGVwcmVjYXRlZFxuICovXG5leHBvcnQgZnVuY3Rpb24gcmF3KC4uLmFyZ3M6IFBhcmFtZXRlcnM8dHlwZW9mIHNxbC5yYXc+KSB7XG4gICAgcmV0dXJuIHNxbC5yYXcoLi4uYXJncyk7XG59XG5cbi8qKlxuICogQGRlcHJlY2F0ZWQgVXNlIHNxbC5hcyBpbnN0ZWFkLlxuICovXG5leHBvcnQgZnVuY3Rpb24gc2VsZWN0QXMoZmllbGRzOiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+KTogU3FsRnJhZyB7XG4gICAgcmV0dXJuIG5ldyBTcWxGcmFnKE9iamVjdC5rZXlzKGZpZWxkcykubWFwKGZpZWxkTmFtZSA9PiBgJHtfZXNjYXBlSWRMb29zZShmaWVsZE5hbWUpfSBBUyAke19lc2NhcGVJZFN0cmljdChmaWVsZHNbZmllbGROYW1lXSl9YCkuam9pbignLCAnKSk7XG59XG5cbi8qKlxuICogQGRlcHJlY2F0ZWRcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIHNldCguLi5hcmdzOiBQYXJhbWV0ZXJzPHR5cGVvZiBzcWwuc2V0Pikge1xuICAgIHJldHVybiBzcWwuc2V0KC4uLmFyZ3MpO1xufVxuXG4vKipcbiAqIEBkZXByZWNhdGVkXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiB0aW1lc3RhbXAoLi4uYXJnczogUGFyYW1ldGVyczx0eXBlb2Ygc3FsLnRpbWVzdGFtcD4pIHtcbiAgICByZXR1cm4gc3FsLnRpbWVzdGFtcCguLi5hcmdzKTtcbn1cblxuLyoqXG4gKiBAZGVwcmVjYXRlZFxuICovXG5leHBvcnQgZnVuY3Rpb24gcG9pbnQoLi4uYXJnczogUGFyYW1ldGVyczx0eXBlb2Ygc3FsLnBvaW50Pikge1xuICAgIHJldHVybiBzcWwucG9pbnQoLi4uYXJncyk7XG59XG5cbi8qKlxuICogQGRlcHJlY2F0ZWRcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIHBvbHlnb24oLi4uYXJnczogUGFyYW1ldGVyczx0eXBlb2Ygc3FsLnBvbHlnb24+KSB7XG4gICAgcmV0dXJuIHNxbC5wb2x5Z29uKC4uLmFyZ3MpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZXNjYXBlVmFsdWUodmFsdWU6IFZhbHVlKTogU3FsRnJhZyB7XG4gICAgaWYgKGlzU2FmZSh2YWx1ZSkpIHJldHVybiB2YWx1ZTtcbiAgICByZXR1cm4gbmV3IFNxbEZyYWcoX2VzY2FwZVZhbHVlKHZhbHVlKSk7XG59XG5cbmZ1bmN0aW9uIGVzY2FwZVJlZ0V4cChzdHJpbmc6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgcmV0dXJuIHN0cmluZy5yZXBsYWNlKC9bLiorP14ke30oKXxbXFxdXFxcXF0vZywgJ1xcXFwkJicpOyAvLyAkJiBtZWFucyB0aGUgd2hvbGUgbWF0Y2hlZCBzdHJpbmdcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGVzY2FwZUxpa2UodmFsdWU6IHN0cmluZywgZXNjQ2hhcjpzdHJpbmcgPSAnXFxcXCcpOiBzdHJpbmcge1xuICAgIGlmKGVzY0NoYXIubGVuZ3RoICE9PSAxIHx8IGVzY0NoYXIgPT09ICclJyB8fCBlc2NDaGFyID09PSAnXycpIHRocm93IG5ldyBFcnJvcihcIkJhZCBlc2NhcGUgY2hhclwiKTtcbiAgICByZXR1cm4gdmFsdWUucmVwbGFjZShuZXcgUmVnRXhwKGBbJV8ke2VzY2FwZVJlZ0V4cChlc2NDaGFyKX1dYCwnZycpLCBtID0+IGVzY0NoYXIgKyBtKTtcbn1cblxuZnVuY3Rpb24gX2VzY2FwZVZhbHVlKHZhbHVlOiBWYWx1ZSk6IHN0cmluZyB7XG4gICAgaWYgKGlzU2FmZSh2YWx1ZSkpIHtcbiAgICAgICAgcmV0dXJuIHZhbHVlLnRvU3FsU3RyaW5nKCk7XG4gICAgfVxuICAgIGlmKEFycmF5LmlzQXJyYXkodmFsdWUpKSB7XG4gICAgICAgIHJldHVybiB2YWx1ZS5tYXAodiA9PiBfZXNjYXBlVmFsdWUodikpLmpvaW4oJywnKTtcbiAgICB9XG4gICAgaWYoQnVmZmVyLmlzQnVmZmVyKHZhbHVlKSkge1xuICAgICAgICByZXR1cm4gYHgnJHt2YWx1ZS50b1N0cmluZygnaGV4Jyl9J2A7XG4gICAgfVxuICAgIGlmKHR5cGVvZiB2YWx1ZSA9PT0gJ251bWJlcicgfHwgdHlwZW9mIHZhbHVlID09PSAnYmlnaW50Jykge1xuICAgICAgICByZXR1cm4gU3RyaW5nKHZhbHVlKTtcbiAgICB9XG4gICAgaWYodHlwZW9mIHZhbHVlID09PSAnc3RyaW5nJykge1xuICAgICAgICByZXR1cm4gX2VzY2FwZVN0cmluZyh2YWx1ZSk7XG4gICAgfVxuICAgIGlmKHZhbHVlID09PSB0cnVlKSB7XG4gICAgICAgIHJldHVybiAnMSc7XG4gICAgfVxuICAgIGlmKHZhbHVlID09PSBmYWxzZSkge1xuICAgICAgICByZXR1cm4gJzAnO1xuICAgIH1cbiAgICBpZih2YWx1ZSA9PT0gbnVsbCkge1xuICAgICAgICByZXR1cm4gJ05VTEwnO1xuICAgIH1cbiAgICB0aHJvdyBuZXcgRXJyb3IoYFVuc3VwcG9ydGVkIHZhbHVlIHR5cGU6ICR7dmFsdWV9YClcbn1cblxuY29uc3QgQ0hBUlNfUkVHRVggPSAvW1xceDAwXFxiXFxuXFxyXFx0XFx4MUEnXFxcXF0vZ3U7XG5jb25zdCBDSEFSU19FU0NBUEVfTUFQOiBSZWNvcmQ8c3RyaW5nLHN0cmluZz4gPSB7XG4gICAgJ1xcMCc6ICdcXFxcMCcsXG4gICAgJ1xcYic6ICdcXFxcYicsXG4gICAgJ1xcbic6ICdcXFxcbicsXG4gICAgJ1xccic6ICdcXFxccicsXG4gICAgJ1xcdCc6ICdcXFxcdCcsXG4gICAgJ1xceDFhJzogJ1xcXFxaJyxcbiAgICAnXFwnJzogXCInJ1wiLFxuICAgICdcXFxcJzogJ1xcXFxcXFxcJ1xufTtcblxuZnVuY3Rpb24gX2VzY2FwZVN0cmluZyh2YWx1ZTogc3RyaW5nKTogc3RyaW5nIHtcbiAgICByZXR1cm4gXCInXCIgKyBTdHJpbmcodmFsdWUpLnJlcGxhY2UoQ0hBUlNfUkVHRVgsbSA9PiBDSEFSU19FU0NBUEVfTUFQW21dKSArIFwiJ1wiO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZXNjYXBlSWQoaWQ6IElkKTogU3FsRnJhZyB7XG4gICAgaWYgKGlzU2FmZShpZCkpIHJldHVybiBpZDtcbiAgICBpZiAoQXJyYXkuaXNBcnJheShpZCkpIHJldHVybiBuZXcgU3FsRnJhZyhpZC5tYXAoX2VzY2FwZUlkU3RyaWN0KS5qb2luKCcuJykpO1xuICAgIHJldHVybiBuZXcgU3FsRnJhZyhfZXNjYXBlSWRTdHJpY3QoaWQpKTtcbn1cblxuZnVuY3Rpb24gX2VzY2FwZUlkTG9vc2UoaWQ6IElkKTogc3RyaW5nIHtcbiAgICBpZihpc1NhZmUoaWQpKSByZXR1cm4gaWQudG9TcWxTdHJpbmcoKTtcbiAgICBpZihBcnJheS5pc0FycmF5KGlkKSkgcmV0dXJuIGlkLm1hcChfZXNjYXBlSWRTdHJpY3QpLmpvaW4oJy4nKTtcbiAgICByZXR1cm4gJ2AnICsgU3RyaW5nKGlkKS5yZXBsYWNlKElEX0dMT0JBTF9SRUdFWFAsICdgYCcpLnJlcGxhY2UoUVVBTF9HTE9CQUxfUkVHRVhQLCAnYC5gJykgKyAnYCc7XG59XG5cbmZ1bmN0aW9uIF9lc2NhcGVJZFN0cmljdChpZDogSWQpOiBzdHJpbmcge1xuICAgIGlmKGlzU2FmZShpZCkpIHJldHVybiBpZC50b1NxbFN0cmluZygpO1xuICAgIGlmKEFycmF5LmlzQXJyYXkoaWQpKSByZXR1cm4gaWQubWFwKF9lc2NhcGVJZFN0cmljdCkuam9pbignLicpO1xuICAgIHJldHVybiAnYCcgKyBTdHJpbmcoaWQpLnJlcGxhY2UoSURfR0xPQkFMX1JFR0VYUCwgJ2BgJykgKyAnYCc7XG59XG5cbnR5cGUgU2luZ2xlVW5lc2NhcGVkVmFsdWUgPSBzdHJpbmcgfCBudW1iZXIgfCBCdWZmZXIgfCBiaWdpbnQgfCBib29sZWFuIHwgbnVsbDtcbnR5cGUgVW5lc2NhcGVkVmFsdWUgPSBTaW5nbGVVbmVzY2FwZWRWYWx1ZXxTaW5nbGVVbmVzY2FwZWRWYWx1ZVtdXG50eXBlIFNpbmdsZVZhbHVlID0gU2luZ2xlVW5lc2NhcGVkVmFsdWV8U3FsRnJhZ1xudHlwZSBWYWx1ZSA9IFNpbmdsZVZhbHVlfFNpbmdsZVZhbHVlW107XG50eXBlIFVuZXNjYXBlZElkID0gc3RyaW5nfFtzdHJpbmddfFtzdHJpbmcsc3RyaW5nXXxbc3RyaW5nLHN0cmluZyxzdHJpbmddO1xudHlwZSBJZCA9IFVuZXNjYXBlZElkfFNxbEZyYWc7XG5cbmV4cG9ydCBmdW5jdGlvbiBkYXRlKHZhbHVlOiBEYXRlIHwgc3RyaW5nIHwgbnVtYmVyIHwgbW9tZW50Lk1vbWVudCwgb3V0cHV0VGltZXpvbmU/OiBzdHJpbmcsIGlucHV0VGltZXpvbmU/OiBzdHJpbmcpOiBTcWxGcmFnIHtcbiAgICAvLyBodHRwczovL2Rldi5teXNxbC5jb20vZG9jL3JlZm1hbi81LjcvZW4vZGF0ZS1hbmQtdGltZS1saXRlcmFscy5odG1sXG4gICAgY29uc3QgZGF0ZSA9IG1ha2VNb21lbnQodmFsdWUsIG91dHB1dFRpbWV6b25lLCBpbnB1dFRpbWV6b25lKTtcbiAgICByZXR1cm4gbmV3IFNxbEZyYWcoYERBVEUnJHtkYXRlLmZvcm1hdCgnWVlZWS1NTS1ERCcpfSdgKVxufVxuXG50eXBlIG5pbCA9IG51bGwgfCB1bmRlZmluZWQ7XG5cbmZ1bmN0aW9uIG1ha2VNb21lbnQodmFsdWU6IG1vbWVudC5Nb21lbnRJbnB1dCwgb3V0cHV0VGltZXpvbmU/OiBzdHJpbmcgfCBudWxsLCBpbnB1dFRpbWV6b25lPzogc3RyaW5nIHwgbnVsbCk6IG1vbWVudC5Nb21lbnQge1xuICAgIGxldCBkO1xuICAgIGlmIChpbnB1dFRpbWV6b25lKSB7XG4gICAgICAgIGNvbnN0IHpvbmUgPSBtb21lbnQudHouem9uZShpbnB1dFRpbWV6b25lKTtcbiAgICAgICAgaWYgKCF6b25lKSB0aHJvdyBuZXcgRXJyb3IoYEludmFsaWQgaW5wdXQgdGltZXpvbmU6ICR7aW5wdXRUaW1lem9uZX1gKTtcbiAgICAgICAgZCA9IG1vbWVudC50eih2YWx1ZSwgem9uZS5uYW1lKTtcbiAgICB9IGVsc2Uge1xuICAgICAgICBkID0gbW9tZW50KHZhbHVlKTtcbiAgICB9XG4gICAgaWYgKCFkLmlzVmFsaWQoKSkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYElucHV0IGRhdGUgaXMgbm90IHZhbGlkYCk7XG4gICAgfVxuICAgIGlmIChvdXRwdXRUaW1lem9uZSkge1xuICAgICAgICBjb25zdCB6b25lID0gbW9tZW50LnR6LnpvbmUob3V0cHV0VGltZXpvbmUpO1xuICAgICAgICBpZiAoIXpvbmUpIHRocm93IG5ldyBFcnJvcihgSW52YWxpZCBvdXRwdXQgdGltZXpvbmU6ICR7b3V0cHV0VGltZXpvbmV9YCk7XG4gICAgICAgIGQudHooem9uZS5uYW1lKVxuICAgIH1cbiAgICByZXR1cm4gZDtcbn1cblxuaW50ZXJmYWNlIFBvaW50IHtcbiAgICB4OiBudW1iZXJcbiAgICB5OiBudW1iZXJcbn1cblxuaW50ZXJmYWNlIExhdExuZyB7XG4gICAgbGF0OiBudW1iZXJcbiAgICBsbmc6IG51bWJlclxufVxuXG50eXBlIE51bWJlclBhaXIgPSBbbnVtYmVyLCBudW1iZXJdXG50eXBlIFBvaW50QXJyYXkgPSBOdW1iZXJQYWlyW10gfCBQb2ludFtdIHwgTGF0TG5nW11cblxuZnVuY3Rpb24gaGFzT3duKG9iajogb2JqZWN0LCBrZXk6IFByb3BlcnR5S2V5KSB7XG4gICAgcmV0dXJuIE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChvYmosIGtleSk7XG59XG5cbmZ1bmN0aW9uIHRvUGFpcnMocG9pbnRzOiBQb2ludEFycmF5KTogTnVtYmVyUGFpcltdIHtcbiAgICBpZiAoIXBvaW50cy5sZW5ndGgpIHJldHVybiBbXTtcbiAgICBjb25zdCBzYW1wbGUgPSBwb2ludHNbMF07XG4gICAgaWYgKEFycmF5LmlzQXJyYXkoc2FtcGxlKSAmJiBzYW1wbGUubGVuZ3RoID09PSAyKSB7XG4gICAgICAgIHJldHVybiBbLi4ucG9pbnRzXSBhcyBOdW1iZXJQYWlyW107XG4gICAgfVxuICAgIGlmIChoYXNPd24oc2FtcGxlLCAneCcpICYmIGhhc093bihzYW1wbGUsICd5JykpIHtcbiAgICAgICAgcmV0dXJuIChwb2ludHMgYXMgUG9pbnRbXSkubWFwKHB0ID0+IFtwdC54LCBwdC55XSk7XG4gICAgfVxuICAgIGlmIChoYXNPd24oc2FtcGxlLCAnbGF0JykgJiYgaGFzT3duKHNhbXBsZSwgJ2xuZycpKSB7XG4gICAgICAgIHJldHVybiAocG9pbnRzIGFzIExhdExuZ1tdKS5tYXAocHQgPT4gW3B0LmxhdCwgcHQubG5nXSk7XG4gICAgfVxuICAgIHRocm93IG5ldyBFcnJvcihcIlBvaW50cyBhcmUgbm90IGluIGFuIGV4cGVjdGVkIGZvcm1hdFwiKVxufVxuXG5cbi8qKlxuICogQGRlcHJlY2F0ZWQgRXhwZXJpbWVudGFsLlxuICovXG5leHBvcnQgZW51bSBJbnRlcnZhbFVuaXQge1xuICAgIC8vIGh0dHBzOi8vZGV2Lm15c3FsLmNvbS9kb2MvcmVmbWFuLzguMC9lbi9leHByZXNzaW9ucy5odG1sXG4gICAgTUlDUk9TRUNPTkQgPSAnTUlDUk9TRUNPTkQnLFxuICAgIE1JTExJU0VDT05EID0gJ01JTExJU0VDT05EJyxcbiAgICBTRUNPTkQgPSAnU0VDT05EJyxcbiAgICBNSU5VVEUgPSAnTUlOVVRFJyxcbiAgICBIT1VSID0gJ0hPVVInLFxuICAgIERBWSA9ICdEQVknLFxuICAgIFdFRUsgPSAnV0VFSycsXG4gICAgTU9OVEggPSAnTU9OVEgnLFxuICAgIFFVQVJURVIgPSAnUVVBUlRFUicsXG4gICAgWUVBUiA9ICdZRUFSJyxcbiAgICAvLyBUT0RPOiBzdXBwb3J0IHRoZSBvdGhlciBjb21wb3VuZCB0eXBlcy5cbn1cblxuLyoqXG4gKiBAZGVwcmVjYXRlZCBFeHBlcmltZW50YWwuXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBpbnRlcnZhbCh2YWx1ZTpudW1iZXIsIHVuaXQ6SW50ZXJ2YWxVbml0PUludGVydmFsVW5pdC5NSUxMSVNFQ09ORCk6IFNxbEZyYWcge1xuICAgIC8vIGh0dHBzOi8vZGV2Lm15c3FsLmNvbS9kb2MvcmVmbWFuLzguMC9lbi9leHByZXNzaW9ucy5odG1sXG4gICAgaWYodW5pdCA9PT0gSW50ZXJ2YWxVbml0Lk1JTExJU0VDT05EKSB7XG4gICAgICAgIC8vIE1pbGxpc2Vjb25kIGRvZXNuJ3QgYWN0dWFsbHkgZXhpc3QgaW4gTXlTUUwgZm9yIHNvbWUgcmVhc29uLlxuICAgICAgICB2YWx1ZSAqPSAxMDAwXG4gICAgICAgIHVuaXQgPSBJbnRlcnZhbFVuaXQuTUlDUk9TRUNPTkQ7XG4gICAgfVxuICAgIC8vIEludGVydmFscyBhcHBlYXIgdG8gYmUgcm91bmRlZCBpbiBNeVNRTFxuICAgIC8vIFNFTEVDVCBUSU1FJzEyOjAwOjAwJyArIElOVEVSVkFMIDEuNSBIT1VSIC0tIDE0OjAwOjAwXG4gICAgcmV0dXJuIG5ldyBTcWxGcmFnKGBJTlRFUlZBTCAke01hdGgucm91bmQodmFsdWUpfSAke3VuaXR9YCk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBzcWwoc3RyaW5nczogVGVtcGxhdGVTdHJpbmdzQXJyYXksIC4uLnZhbHVlczogVmFsdWVbXSk6IFNxbEZyYWcge1xuICAgIGxldCBvdXQgPSBbXTtcbiAgICBsZXQgaSA9IDA7XG4gICAgZm9yICg7IGkgPCB2YWx1ZXMubGVuZ3RoOyArK2kpIHtcbiAgICAgICAgb3V0LnB1c2goc3RyaW5ncy5yYXdbaV0sIGVzY2FwZVZhbHVlKHZhbHVlc1tpXSkudG9TcWxTdHJpbmcoKSk7XG4gICAgfVxuICAgIG91dC5wdXNoKHN0cmluZ3MucmF3W2ldKTtcbiAgICByZXR1cm4gbmV3IFNxbEZyYWcob3V0LmpvaW4oJycpKTtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBJbnNlcnRPcHRpb25zIHtcbiAgICAvKipcbiAgICAgKiBJZ25vcmUgZHVwbGljYXRlIHJlY29yZHMuXG4gICAgICovXG4gICAgaWdub3JlRHVwZXM/OiBib29sZWFuXG4gICAgdXBkYXRlT25EdXBlPzogYm9vbGVhblxuICAgIGlnbm9yZT86IGJvb2xlYW5cbn1cblxuZXhwb3J0IG5hbWVzcGFjZSBzcWwge1xuICAgIGV4cG9ydCBmdW5jdGlvbiBzZXQoZmllbGRzOiBSZWNvcmQ8c3RyaW5nLCBWYWx1ZT58QXJyYXk8W0lkLFZhbHVlXT4pOiBTcWxGcmFnIHtcbiAgICAgICAgaWYoQXJyYXkuaXNBcnJheShmaWVsZHMpKSB7XG4gICAgICAgICAgICByZXR1cm4gbmV3IFNxbEZyYWcoZmllbGRzLm1hcChmID0+IGAke2VzY2FwZUlkKGZbMF0pLnRvU3FsU3RyaW5nKCl9PSR7ZXNjYXBlVmFsdWUoZlsxXSkudG9TcWxTdHJpbmcoKX1gKS5qb2luKCcsICcpKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gbmV3IFNxbEZyYWcoT2JqZWN0LmtleXMoZmllbGRzKS5tYXAoZmllbGROYW1lID0+IGAke19lc2NhcGVJZExvb3NlKGZpZWxkTmFtZSl9PSR7ZXNjYXBlVmFsdWUoZmllbGRzW2ZpZWxkTmFtZV0pLnRvU3FsU3RyaW5nKCl9YCkuam9pbignLCAnKSk7XG4gICAgfVxuICAgIGV4cG9ydCBmdW5jdGlvbiBpbnNlcnQ8U2NoZW1hIGV4dGVuZHMgb2JqZWN0PVJlY29yZDxzdHJpbmcsIFZhbHVlPj4odGFibGU6IElkLCBkYXRhOiBQYXJ0aWFsPFNjaGVtYT58QXJyYXk8W0lkLFZhbHVlXT4sIG9wdGlvbnM/OiBJbnNlcnRPcHRpb25zKTogU3FsRnJhZyB7XG4gICAgICAgIGxldCBxID0gc3FsYElOU0VSVCAke3NxbC5yYXcob3B0aW9ucz8uaWdub3JlID8gJ0lHTk9SRSAnIDogJycpfUlOVE8gJHtlc2NhcGVJZCh0YWJsZSl9IFNFVCAke3NxbC5zZXQoZGF0YSBhcyBhbnkpfWA7XG4gICAgICAgIGlmIChvcHRpb25zPy5pZ25vcmVEdXBlcykge1xuICAgICAgICAgICAgaWYob3B0aW9ucz8udXBkYXRlT25EdXBlKSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiYGlnbm9yZUR1cGVzYCBhbmQgYHVwZGF0ZU9uRHVwZWAgYXJlIGluY29tcGF0aWJsZVwiKVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgbGV0IGZpcnN0Q29sOiBJZDtcbiAgICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KGRhdGEpKSB7XG4gICAgICAgICAgICAgICAgZmlyc3RDb2wgPSBkYXRhWzBdWzBdO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBmaXJzdENvbCA9IE9iamVjdC5rZXlzKGRhdGEpWzBdO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgY29uc3QgZXNjQ29sID0gbmV3IFNxbEZyYWcoX2VzY2FwZUlkTG9vc2UoZmlyc3RDb2wpKTtcbiAgICAgICAgICAgIHEgPSBzcWxgJHtxfSBPTiBEVVBMSUNBVEUgS0VZIFVQREFURSAke2VzY0NvbH09VkFMVUVTKCR7ZXNjQ29sfSlgO1xuICAgICAgICB9XG4gICAgICAgIGlmKG9wdGlvbnM/LnVwZGF0ZU9uRHVwZSkge1xuICAgICAgICAgICAgbGV0IGNvbHM6IElkW107XG4gICAgICAgICAgICBpZihBcnJheS5pc0FycmF5KGRhdGEpKSB7XG4gICAgICAgICAgICAgICAgY29scyA9IGRhdGEubWFwKGYgPT4gZlswXSk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGNvbHMgPSBPYmplY3Qua2V5cyhkYXRhKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHEgPSBzcWxgJHtxfSBPTiBEVVBMSUNBVEUgS0VZIFVQREFURSAke2NvbHMubWFwKGNvbCA9PntcbiAgICAgICAgICAgICAgICBjb25zdCBlc2NDb2wgPSBuZXcgU3FsRnJhZyhfZXNjYXBlSWRMb29zZShjb2wpKTtcbiAgICAgICAgICAgICAgICByZXR1cm4gc3FsYCR7ZXNjQ29sfT1WQUxVRVMoJHtlc2NDb2x9KWBcbiAgICAgICAgICAgIH0pfWA7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHE7XG4gICAgfVxuXG4gICAgZXhwb3J0IGZ1bmN0aW9uIGFzKGZpZWxkczogUmVjb3JkPHN0cmluZywgSWQ+fEFycmF5PFtJZCxzdHJpbmddPik6IFNxbEZyYWcge1xuICAgICAgICBpZihBcnJheS5pc0FycmF5KGZpZWxkcykpIHtcbiAgICAgICAgICAgIHJldHVybiBuZXcgU3FsRnJhZyhmaWVsZHMubWFwKGYgPT4gYCR7ZXNjYXBlSWQoZlswXSkudG9TcWxTdHJpbmcoKX0gQVMgJHtfZXNjYXBlU3RyaW5nKGZbMV0pfWApLmpvaW4oJywgJykpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBuZXcgU3FsRnJhZyhPYmplY3Qua2V5cyhmaWVsZHMpLm1hcChhbGlhcyA9PiBgJHtfZXNjYXBlSWRTdHJpY3QoZmllbGRzW2FsaWFzXSl9IEFTICR7X2VzY2FwZVN0cmluZyhhbGlhcyl9YCkuam9pbignLCAnKSk7XG4gICAgfVxuICAgIGV4cG9ydCBmdW5jdGlvbiByYXcoc3FsU3RyaW5nOiBzdHJpbmcgfCBTcWxGcmFnKTogU3FsRnJhZyB7XG4gICAgICAgIGlmIChzcWxTdHJpbmcgaW5zdGFuY2VvZiBTcWxGcmFnKSByZXR1cm4gc3FsU3RyaW5nO1xuICAgICAgICByZXR1cm4gbmV3IFNxbEZyYWcoc3FsU3RyaW5nKTtcbiAgICB9XG4gICAgZXhwb3J0IGZ1bmN0aW9uIHRpbWVzdGFtcCh2YWx1ZTogbW9tZW50Lk1vbWVudElucHV0LCBvdXRwdXRUaW1lem9uZT86IHN0cmluZyB8IG51bGwsIGlucHV0VGltZXpvbmU/OiBzdHJpbmcgfCBudWxsLCBmc3A/OiBudW1iZXIgfCBudWxsKTogU3FsRnJhZyB7XG4gICAgICAgIC8vIGh0dHBzOi8vZGV2Lm15c3FsLmNvbS9kb2MvcmVmbWFuLzUuNy9lbi9kYXRlLWFuZC10aW1lLWxpdGVyYWxzLmh0bWxcbiAgICAgICAgLy8gaHR0cHM6Ly9tb21lbnRqcy5jb20vZG9jcy8jL2Rpc3BsYXlpbmcvZm9ybWF0L1xuICAgICAgICBjb25zdCBkYXRlID0gbWFrZU1vbWVudCh2YWx1ZSwgb3V0cHV0VGltZXpvbmUsIGlucHV0VGltZXpvbmUpO1xuICAgICAgICBsZXQgZnJhYyA9ICcnO1xuICAgICAgICBpZiAoZnNwICE9IG51bGwpIHtcbiAgICAgICAgICAgIGlmIChmc3AgPCAwIHx8IGZzcCA+IDYpIHtcbiAgICAgICAgICAgICAgICAvLyBodHRwczovL2Rldi5teXNxbC5jb20vZG9jL3JlZm1hbi84LjAvZW4vZGF0ZS1hbmQtdGltZS10eXBlLW92ZXJ2aWV3Lmh0bWxcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYGZzcCBvdXQgb2YgcmFuZ2U6ICR7ZnNwfWApO1xuICAgICAgICAgICAgfSBlbHNlIGlmIChmc3AgPiAwKSB7XG4gICAgICAgICAgICAgICAgZnJhYyA9ICcuJyArICdTJy5yZXBlYXQoZnNwKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIGlmIChkYXRlLm1pbGxpc2Vjb25kcygpICE9PSAwKSB7XG4gICAgICAgICAgICBmcmFjID0gJy5TU1MnO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIG5ldyBTcWxGcmFnKGBUSU1FU1RBTVAnJHtkYXRlLmZvcm1hdChgWVlZWS1NTS1ERCBISDptbTpzcyR7ZnJhY31gKX0nYClcbiAgICB9XG4gICAgZXhwb3J0IGZ1bmN0aW9uIHBvaW50KHg6IG51bWJlciwgeTogbnVtYmVyKTogU3FsRnJhZyAge1xuICAgICAgICByZXR1cm4gc3FsYFBvaW50RnJvbVRleHQoJHtgUE9JTlQoJHt4fSAke3l9KWB9KWA7XG4gICAgfVxuICAgIGV4cG9ydCBmdW5jdGlvbiBwb2x5Z29uKHBvaW50czogUG9pbnRBcnJheSwgYXV0b0NvbXBsZXRlID0gdHJ1ZSk6IFNxbEZyYWcgIHtcbiAgICAgICAgLy8gaHR0cHM6Ly9kZXYubXlzcWwuY29tL2RvYy9yZWZtYW4vNS43L2VuL2dpcy1kYXRhLWZvcm1hdHMuaHRtbFxuICAgICAgICAvLyBodHRwczovL2VuLndpa2lwZWRpYS5vcmcvd2lraS9XZWxsLWtub3duX3RleHRfcmVwcmVzZW50YXRpb25fb2ZfZ2VvbWV0cnkjV2VsbC1rbm93bl9iaW5hcnlcbiAgICAgICAgaWYgKCFwb2ludHMubGVuZ3RoKSB0aHJvdyBuZXcgRXJyb3IoXCJDYW5ub3QgY3JlYXRlIGFuIGVtcHR5IHBvbHlnb25cIik7XG4gICAgICAgIHBvaW50cyA9IHRvUGFpcnMocG9pbnRzKTtcbiAgICAgICAgaWYgKGF1dG9Db21wbGV0ZSkge1xuICAgICAgICAgICAgY29uc3QgbCA9IHBvaW50cy5sZW5ndGggLSAxO1xuICAgICAgICAgICAgaWYgKCEocG9pbnRzWzBdWzBdID09PSBwb2ludHNbbF1bMF0gJiYgcG9pbnRzWzBdWzFdID09PSBwb2ludHNbbF1bMV0pKSB7XG4gICAgICAgICAgICAgICAgcG9pbnRzLnB1c2goW3BvaW50c1swXVswXSwgcG9pbnRzWzBdWzFdXSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHNxbGBQb2x5RnJvbVRleHQoJHtgUE9MWUdPTigoJHtcbiAgICAgICAgICAgIHBvaW50cy5tYXAoKFt4LCB5XSkgPT4gYCR7eH0gJHt5fWApLmpvaW4oJywnKVxuICAgICAgICB9KSlgfSlgO1xuICAgIH1cblxufVxuIl19